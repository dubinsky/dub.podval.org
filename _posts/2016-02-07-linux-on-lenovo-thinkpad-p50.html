---
layout: post
title: Linux on Lenovo ThinkPad p50
date: '2016-02-07T17:21:00.000-05:00'
author: Leonid Dubinsky
tags: 
modified_time: '2016-09-25T15:12:23.835-04:00'
blogger_id: tag:blogger.com,1999:blog-8681083740214020499.post-5982252303112752973
blogger_orig_url: https://blog.dub.podval.org/2016/02/linux-on-lenovo-thinkpad-p50.html
---

<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">I am in the process of setting up my new Lenovo ThinkPad <a href="http://shop.lenovo.com/us/en/laptops/thinkpad/p-series/p50/">P50</a>. Here are some problems I encountered and solutions I found. There is no lasting value to these notes, even as notes to self: most of these issues will probably just go away soon. I am writing this mainly for the entertainment value.</span><br />
<h4>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">Hardware</span></h4>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">Since Lenovo RAM and storage upgrade prices are outrageous (2-4 times the market price!),</span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">it makes sense to buy their base RAM and storage options and upgrade with aftermarket parts. On the other hand, their base storage option is a $140 hard drive, which is at this point completely useless. And the next one is a $400 256G SSD, which is around 5 times overpriced... For me, the decision was made by the fact that Lenovo promised to ship in 10-12 business days, but NewEgg had pre-configured &nbsp;model with the CPU I wanted ready to ship. Since NewEgg - unlike Lenovo - doesn't take taxes, their price was comparable with the Lenovo's even with the "friends and family" discount. I went with NewEgg - and the SSD option.</span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">I ordered 16G more of RAM and a 512G Samsung 950 Pro <a href="http://www.newegg.com/Product/Product.aspx?Item=N82E16820147467">NVMe SSD</a> and installed them myself. I consulted Hardware Maintenance <a href="https://download.lenovo.com/pccbbs/mobiles_pdf/p50_ug_en.pdf">Manual</a>, and that is how I figured out that I am installing RAM in the wrong slot and the NVMe drive upside down :)</span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">NVMe drives require a special <a href="http://shop.lenovo.com/us/en/itemdetails/4XB0K59917/460/7EF7D50A5A7047049A355BF42AAF3C5C">tray</a>. I ordered one from Lenovo, but that takes a while. Although it was not clear from the specifications of the model I ordered what format is the SSD - 2.5" or M.2, my machine came with an M.2 SSD, so I just replaced it with the one I bought (I'll put the original one back into the machine once the tray arrives).</span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span></div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">As <a href="http://www.notebookcheck.net/Lenovo-ThinkPad-P50-Workstation-Review.158713.0.html">notebookcheck review</a> mentioned, maintenance cover is "secured by small plastic clips, so you have to be careful not to break them". I used flat metal thingy from a <a href="http://www.amazon.com/gp/product/B00VJYWRKW">toolkit</a> I got. The clips survived :)</span><br />
<div>
<h4>
<span id="docs-internal-guid-ed118543-bd6b-c96f-b786-efb1583c2241">BIOS Update</span></h4>
<span style="font-family: arial, helvetica, sans-serif; vertical-align: baseline; white-space: pre-wrap;">Next</span><span style="font-family: arial, helvetica, sans-serif; vertical-align: baseline; white-space: pre-wrap;">, I tried booting into Fedora 23 Live USB stick. After much screen blinking, I got to the command line prompt, where I found no graphical interface, no running installer and a bunch of errors.</span><span id="docs-internal-guid-ed118543-bd6b-c96f-b786-efb1583c2241"></span><br />
<span id="docs-internal-guid-ed118543-bd6b-c96f-b786-efb1583c2241">
</span>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span id="docs-internal-guid-ed118543-bd6b-c96f-b786-efb1583c2241"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><span style="vertical-align: baseline; white-space: pre-wrap;"><br /></span></span></span></div>
<span id="docs-internal-guid-ed118543-bd6b-c96f-b786-efb1583c2241">
</span><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><span style="vertical-align: baseline; white-space: pre-wrap;">I heard that some bugs were fixed in the later versions of the BIOS, and decided to upgrade it. Since at this point I didn't have the Windows drive in the machine any longer, and in general I do now want to use Windows, I started looking for a way to flash the BIOS without Windows. &nbsp;</span></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 1.38; white-space: pre-wrap;">Lenovo publishes a </span><a href="http://support.lenovo.com/us/en/downloads/ds106109" style="font-family: Arial, Helvetica, sans-serif; line-height: 1.38; white-space: pre-wrap;">bootable CD</a><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 1.38; white-space: pre-wrap;"> image with the BIOS updater (which is a little weird, since many laptops - including P50 - do not have a CD drive :)).</span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 1.38; white-space: pre-wrap;"><br /></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 1.38; white-space: pre-wrap;">I wrote that image onto an USB stick; it didn't boot. Document </span><span style="color: #1155cc; font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 1.38; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;"><a href="http://positon.org/lenovo-thinkpad-bios-update-with-linux-and-usb" style="font-family: Arial, Helvetica, sans-serif; line-height: 1.38; text-decoration: none;">Lenovo Thinkpad BIOS Update with Linux and USB</a></span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 1.38; white-space: pre-wrap;"> reminded me that CD image isn't a bootable disk image - it <i>contains</i> bootable disk images. There is a tool for extracting first such from a CD image - "geteltorito". On Fedora 24, it is not in the “genisoimage” package, but in the "geteltorito" package.</span></div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: arial, helvetica, sans-serif; white-space: pre-wrap;">$ geteltorito -o bios.img </span>n1eur16w.iso<span style="font-family: arial, helvetica, sans-serif; white-space: pre-wrap;"> # last argument - Bootable CD image from Lenovo</span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="vertical-align: baseline; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">$ sudo dd if=bios.img of=/dev/sdX # where the USB stick is</span></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="vertical-align: baseline; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="vertical-align: baseline; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">BIOS updated fine, but Fedora Live still didn't boot :(</span></span></div>
<br />
<h4>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">Skylake</span></h4>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 1.38; white-space: pre-wrap;"></span><br />
<div dir="ltr" style="margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 1.38; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 1.38; white-space: pre-wrap;">Among the errors that I saw booting Fedora 23 was </span><span style="line-height: 1.38;">"</span><span style="line-height: 1.38;">snd_hda_intel … &nbsp;failed to add i915 component master", </span><span style="line-height: 1.38;">which - although sound-related - mentions "i915", which is Intel integrated graphics driver. </span><span style="line-height: 1.38;">Linux kernel version 3.2 in Fedora 23 that I was trying to boot predates the Skylake processor in my machine, and I thought that the problems I was seeing are caused by the lack of the Skylake support in the 3.2 kernel.</span></span></div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 1.38; white-space: pre-wrap;">
<div dir="ltr" style="font-size: 14.6667px; margin-bottom: 0pt; margin-top: 0pt;">
<br /></div>
<div dir="ltr" style="margin-bottom: 0pt; margin-top: 0pt;">
<span style="line-height: 1.38;">I didn't know any easy way of making a bootable Fedora USB stick with a kernel that supports Skylake, so I googled the topic, and found out (in</span><span style="vertical-align: baseline;"> “</span><a href="http://www.phoronix.com/scan.php?page=news_item&amp;px=intel-skl-prelim-support" style="line-height: 22.08px; text-decoration: none;"><span style="color: #1155cc; text-decoration: underline; vertical-align: baseline;">Early Intel Skylake Linux Users May Run Into A Silly Issue</span></a><span style="vertical-align: baseline;">” by </span><a href="http://www.michaellarabel.com/" style="line-height: 22.08px; text-decoration: none;"><span style="color: #1155cc; text-decoration: underline; vertical-align: baseline;">Michael Larabel</span></a><span style="line-height: 1.38;">) that 3.2 kernel <i>does</i> support Skylake - when a parameter is added to the kernel command line: "</span><span style="line-height: 1.38;">i915.preliminary_hw_support=1".</span></div>
</span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span></div>
After this, I was able to boot Fedora 23 Live and install it onto my NVMe drive!</span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">Booting into the newly-installed system didn't work, though.</span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">I figured that the installed system also needs the "i915" parameter added to its kernel command line, so I rebooted into the Fedora 23 Live USB, mounted what I needed and changed "</span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 20.24px; white-space: pre-wrap;">grub.cfg". I know that I am supposed to change "</span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 20.24px; white-space: pre-wrap;">/etc/default/grub</span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 20.24px; white-space: pre-wrap;"><span style="line-height: 20.24px; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">" ins</span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">tead a</span></span></span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">nd run grub2-mkconfig, </span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 20.24px; white-space: pre-wrap;"><span style="line-height: 20.24px; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">but I need to mount more filesystems and do a "chroot" f</span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">or that (see </span></span><a href="http://searchenterpriselinux.techtarget.com/tip/Its-an-easy-fix-to-clean-up-a-GRUB-error-on-your-Linux-server" style="font-family: arial, helvetica, sans-serif; line-height: 20.24px; white-space: pre-wrap;">instructions</a><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 20.24px; white-space: pre-wrap;">), and I am too lazy. Also, once newly-install system boots, I update it, and current Fedora 23 kernel - 4.3.4 - seems to have Skylake support enabled, so there is no need to supply any parameters and touching </span></span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 20.24px; white-space: pre-wrap;">"</span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 20.24px; white-space: pre-wrap;">/etc/default/grub</span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 20.24px; white-space: pre-wrap;"><span style="line-height: 20.24px; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">".</span></span></span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 20.24px; white-space: pre-wrap;"><br /></span></div>
<div>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; line-height: 20.24px; white-space: pre-wrap;">Installed system still didn't boot.</span><br />
<h4>
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">EFI</span></h4>
</div>
<div>
<br />
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="vertical-align: baseline; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">I pressed F12 during boot, to see what can be booted. My drive was among the options, but even if I selected it manually, list of boot options soon reappeared - as if BIOS tried to boot my drive and failed.</span></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="vertical-align: baseline; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="vertical-align: baseline; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">This is when I noticed that the drive is listed as "NVMe EFI" drive. I previously verified that BIOS is set to boot both "legacy" (pre-UEFI) and UEFI OSs, and try "legacy" first. Now it seemed that the BIOS is hinting to me that it will only boot UEFI systems from my NVMe drive - and Fedora 23 that I just installed there was, of course, installed as a "legacy" OS!</span></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="vertical-align: baseline; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="vertical-align: baseline; white-space: pre-wrap;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">I probably was supposed to know from UEFI by now - but I didn't :(</span></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; font-size: 14.6667px; vertical-align: baseline; white-space: pre-wrap;"><br /></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; vertical-align: baseline; white-space: pre-wrap;">I found the excellent “<a href="http://www.rodsbooks.com/linux-uefi/">Linux on UEFI</a>: A Quick Installation Guide” by Roderick W. Smith, and in the very beginning of it I learned that in order for my Linux installation to be UEFI, the installer needs to boot in UEFI. My USB stick can boot as both "legacy" and UEFI, but since BIOS tries "legacy" first, it boots in "legacy" mode. I set the BIOS to boot only UEFI - as the text recommended - and my installer booted the way it should (and much faster - no time wasted trying the thegacy boot)!</span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; vertical-align: baseline; white-space: pre-wrap;"><br /></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; vertical-align: baseline; white-space: pre-wrap;">Last hurdle: since I already had a "legacy" Linux installation on the drive, it had a "legacy" partition table, whereas UEFI needs a GTP partition table... I used "gdisk" - a GTP flavor of fdisk - from Fedora Live to write a new GTP partition table.</span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; vertical-align: baseline; white-space: pre-wrap;"><br /></span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; vertical-align: baseline; white-space: pre-wrap;">Fedora 23 installed and working!</span></div>
<div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;">
<span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; font-size: 14.6667px; vertical-align: baseline; white-space: pre-wrap;"><br /></span></div>
</div>
