---
layout: post
title: Creating executable JARs with Maven
date: '2009-10-18T15:50:00.027-04:00'
author: dub
tags:
- maven
- java
modified_time: '2013-04-25T15:21:13.777-04:00'
blogger_id: tag:blogger.com,1999:blog-8681083740214020499.post-2506818829173082354
blogger_orig_url: https://blog.dub.podval.org/2009/10/creating-executable-jars-with-maven.html
---

<h3>Maven Assembly Plugin</h3><br />
I wanted to make a self-containded executable JAR for the project mentioned in a previous  <a href="http://blog.dub.podval.org/2009/08/consuming-zenfolio.html">post</a>. I used <a href="http://www.sonatype.com/books/maven-book/reference/assemblies.html">Assembly</a> plugin.  Some of the transitive dependencies are not really needed in my case, and I did not want to include them. Assembly plugin provides full control over the contents of the archive through the assembly descriptor. Also, exclusions can be used on the direct dependencies to control the dependencies set, and then the assembly can be created using predefined "jar-with-dependencies" descriptor. <br />
<br />
<h3>One-JAR™</h3><br />
Resulting archive then contains what I want, but all the dependency JARs are unpacked. That causes confusion (and, potentially, proliferation of files with the same names :)). I'd like to put dependencies' JARs into a "lib" folder in the executable archive, and use JAR classloader mechanisms to load classes from the jars-within-the-jar. <br />
<a name='more'></a>I am far from the first to think that this approach should just work. But it does not: built-in classloader won't open the nested JARs! There is a enhancement <a href="http://bugs.sun.com/view_bug.do?bug_id=4648386">request</a> that's been filed years ago, and eventually this may start working as expected, but not yet.<br />
It turned out that I did not have to write my own classloader. P. Simon Tuffs already created  a wonderful solution: <a href="http://one-jar.sourceforge.net/">One-JAR™</a> classloader.<br />
I want to use java.util.ServiceLoader in my project, for dynamic discovery of service providers. I was worried about it not working with the One-Jar approach. Everything works just fine! <br />
<br />
<h3>Maven and One-JAR™</h3><br />
I used Brian Oxley's <a href="http://binkley.blogspot.com/2006/12/making-one-jar-with-maven.html">advice</a> on how to integrate Maven with One Jar using Assembly plugin.  Dependency on One-Jar has to be added:  <br />
<pre><code class="language-xml">
&lt;dependency>
    &lt;groupid>com.simontuffs&lt;/groupid>
    &lt;artifactid>one-jar&lt;/artifactid>
    &lt;version>0.97&lt;/version>
&lt;/dependency>
</code></pre>I couldn't find One-Jar in any Maven repository, so it has to be loaded into your corporate repository, or to a <a href="http://blog.dub.podval.org/2010/01/maven-in-project-repository.html">in-project repository</a>.<br />
<br />
&nbsp;Here is my Assembly plugin stanza:<br />
<pre><code class="language-markup">&lt;plugin&gt;
    &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
    &lt;configuration&gt;
        &lt;descriptors&gt;
            &lt;descriptor&gt;src/main/assembly/assembly.xml&lt;/descriptor&gt;
        &lt;/descriptors&gt;
        &lt;archive&gt;
            &lt;manifest&gt;
                &lt;!-- For One Jar executable, mainClass is the One Jar entry point: --&gt;
                &lt;mainClass&gt;com.simontuffs.onejar.Boot&lt;/mainClass&gt;
            &lt;/manifest&gt;
            &lt;manifestEntries&gt;
                <one-jar-main-class>FQN OF THE REAL MAIN CLASS</one-jar-main-class>
            &lt;/manifestEntries&gt;
        &lt;/archive&gt;
    &lt;/configuration&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;make-assembly&lt;/id&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;single&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>And the assembly descriptor has the following:<br />
<pre><code class="language-markup">
&lt;assembly&gt;
  &lt;id&gt;one-jar&lt;/id&gt;

  &lt;formats&gt;
    &lt;format&gt;jar&lt;/format&gt;
  &lt;/formats&gt;

  &lt;includeBaseDirectory&gt;false&lt;/includeBaseDirectory&gt;

  &lt;dependencySets&gt;
    &lt;!-- One Jar classloader itself --&gt;
    &lt;dependencySet&gt;
        &lt;outputDirectory/&gt;
        &lt;unpack&gt;true&lt;/unpack&gt;
        &lt;includes&gt;
            &lt;include&gt;com.simontuffs:one-jar&lt;/include&gt;
        &lt;/includes&gt;
        &lt;unpackOptions&gt;
            &lt;includes&gt;
                &lt;include&gt;OneJar.class&lt;/include&gt;
                &lt;include&gt;com/**&lt;/include&gt;
                &lt;include&gt;doc/**&lt;/include&gt;
            &lt;/includes&gt;
        &lt;/unpackOptions&gt;
    &lt;/dependencySet&gt;

    &lt;!-- Project JAR --&gt;
    &lt;dependencySet&gt;
        &lt;outputDirectory&gt;main&lt;/outputDirectory&gt;
        &lt;includes&gt;
          &lt;include&gt;${groupId}:${artifactId}&lt;/include&gt;
        &lt;/includes&gt;
        &lt;!--&lt;outputFileNameMapping&gt;main.jar&lt;/outputFileNameMapping&gt;--&gt;
    &lt;/dependencySet&gt;

    &lt;!-- Dependencies --&gt;
    &lt;dependencySet&gt;
        &lt;outputDirectory&gt;lib&lt;/outputDirectory&gt;
        &lt;useTransitiveDependencies&gt;true&lt;/useTransitiveDependencies&gt;
        &lt;excludes&gt;
            &lt;exclude&gt;com.simontuffs:one-jar&lt;/exclude&gt;
            &lt;exclude&gt;${groupId}:${artifactId}&lt;/exclude&gt;
        &lt;/excludes&gt;
    &lt;/dependencySet&gt;
  &lt;/dependencySets&gt;
&lt;/assembly&gt;
</code></pre>Interestingly enough, the assembly descripto is completely project-independent, and can be reused in other projects.<br />
<br />
<h3>One-Jar Maven plugin</h3><br />
There is also a Maven2 <a href="http://code.google.com/p/onejar-maven-plugin/">plugin</a> that integrates with One Jar. To use it, additional plugin repository needs to be configured. On the other hand, dependency on One-Jar does not need to be declared. Assembly descriptor and assembly plugin are not needed either.<br />
Resulting configuration is short and simple. Here is the plugin repository configuration:<br />
<pre><code class="language-markup">
&lt;pluginRepositories&gt;
    &lt;pluginRepository&gt;
        &lt;id&gt;onejar-maven-plugin.googlecode.com&lt;/id&gt;
        &lt;url&gt;http://onejar-maven-plugin.googlecode.com/svn/mavenrepo&lt;/url&gt;
    &lt;/pluginRepository&gt;
&lt;/pluginRepositories&gt;
</code></pre>And this is how I configured the One-Jar plugin:<br />
<pre><code class="language-markup">&lt;plugin&gt;
    &lt;groupId&gt;org.dstovall&lt;/groupId&gt;
    &lt;artifactId&gt;onejar-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;1.4.1&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;configuration&gt;
                &lt;mainClass&gt;.....&lt;/mainClass&gt;
            &lt;/configuration&gt;
            &lt;goals&gt;
                &lt;goal&gt;one-jar&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre><br />
<h3>Interoperation with Guice</h3><br />
Running Guice from within One-Jar produces a nasty warning about class loaders. The solution (until One-Jar is fixed) is to <a href="http://code.google.com/p/google-guice/wiki/ClassLoading">disable</a> Guice's bridge class loader. This solution is <a href="http://sourceforge.net/projects/one-jar/forums/forum/380844/topic/3542317">described</a> by Niall Gallagher.<br />
<pre><code class="language-java">System.setProperty("guice.custom.loader", "false");</code></pre>It seems that starting with version 0.97 (supported by One-Jar plugin staring with bersion 1.4.4) the issue has been fixed! <br />
<br />
<h3>Interoperation with JNA</h3><br />
I heard about some issues in the past, but right now One-Jar and JNA seem to work well together.<br />
